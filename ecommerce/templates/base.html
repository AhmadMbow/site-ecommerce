{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Ecommerce{% endblock %}</title>

  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  <link rel="shortcut icon" href="{% static 'favicon.ico' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    :root{
      --gold: #ffc107;
      --dark: #232526;
      --light: #f8f9fa;
      --soft: #ffffff;
      --radius: .75rem;
      --shadow-sm: 0 6px 18px rgba(0,0,0,0.06);
      --shadow: 0 12px 30px rgba(0,0,0,0.10);
      --shadow-lg: 0 22px 48px rgba(0,0,0,0.16);
      --nav-offset: 72px; /* fallback */
    }

    html { scroll-behavior: smooth; }
    body{
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      color: var(--dark);
      background: #fff;
      line-height: 1.55;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      padding-top: var(--nav-offset);
    }

    /* Headings refinement */
    h1,h2,h3,h4,h5,h6{
      font-weight: 700;
      letter-spacing: .2px;
    }

    /* Global interactive comfort */
    a, .btn, .nav-link, .dropdown-item, .navbar-brand, .bi, .fa {
      transition: color .25s ease, background-color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .18s ease;
    }

    /* Cards + alerts consistency (in case pages render cards) */
    .card{
      border: 0 !important;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }
    .card:hover{ box-shadow: var(--shadow); transform: translateY(-4px); }
    .alert{
      border: 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
    }

    /* NAVBAR: fixed glass + scroll shadow */
    .navbar{
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 1040;
      background: rgba(255,255,255,0.85) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 6px 22px rgba(0,0,0,0.06);
      border-bottom: 1px solid rgba(0,0,0,0.04) !important;
    }
    .navbar.is-scrolled{
      background: rgba(255,255,255,0.95) !important;
      box-shadow: 0 10px 28px rgba(0,0,0,0.10);
    }

    /* Brand and links: dark -> gold on hover/active */
    .navbar .navbar-brand,
    .navbar .nav-link{
      color: var(--dark) !important;
      font-weight: 600;
    }
    .navbar .navbar-brand:hover,
    .navbar .nav-link:hover,
    .navbar .nav-link:focus{
      color: var(--gold) !important;
    }
    .navbar .nav-link.active{
      color: var(--gold) !important;
    }

    /* Dropdown menu: elegant surface + animation */
    .dropdown-menu{
      border: 0;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
      opacity: 0;
      transform: translateY(6px) scale(0.98);
      transition: opacity .18s ease, transform .18s ease;
      overflow: hidden;
    }
    .dropdown-menu.show{
      opacity: 1;
      transform: none;
    }
    .dropdown-item{
      padding: .6rem .95rem;
      border-radius: .5rem;
    }
    .dropdown-item:hover, .dropdown-item:focus{
      background: rgba(255,193,7,0.12);
      color: var(--dark);
    }
    .dropdown-header{
      padding-top: .75rem;
      padding-bottom: .25rem;
    }
    .dropdown-divider{ margin: .35rem 0; }

    /* Toggler for mobile */
    .navbar-toggler{
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: .6rem;
      padding: .4rem .6rem;
    }
    .navbar-toggler:focus{ box-shadow: 0 0 0 .2rem rgba(255,193,7,.25); }

    /* Buttons: unify style */
    .btn{
      border-radius: calc(var(--radius) - 2px);
      font-weight: 600;
      will-change: transform, box-shadow;
    }
    .btn:active{ transform: translateY(0.5px) scale(0.98); }

    /* Login (Connexion) -> gold filled (target only in navbar) */
    .navbar .btn-dark{
      background-color: var(--gold) !important;
      border-color: var(--gold) !important;
      color: #111 !important;
      box-shadow: 0 8px 22px rgba(255,193,7,.25);
    }
    .navbar .btn-dark:hover{
      filter: brightness(0.95);
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(255,193,7,.35);
    }

    /* Register (Inscription) -> black with gold border */
    .navbar .btn-outline-dark{
      color: var(--dark) !important;
      border: 2px solid var(--gold) !important;
      background: #fff !important;
    }
    .navbar .btn-outline-dark:hover{
      background: var(--dark) !important;
      color: #fff !important;
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(35,37,38,.2);
    }

    /* Generic outline-dark buttons (including cart) */
    .btn-outline-dark{
      border-width: 2px;
    }
    .btn-outline-dark:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(35,37,38,.2);
    }

    /* Cart button + badge */
    .navbar .bi-cart3{ transition: transform .18s ease; }
    .navbar a.btn:hover .bi-cart3{ transform: translateY(-1px) scale(1.05); }
    .cart-count{
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(255,193,7,.35);
    }
    .cart-count.bg-dark{
      background-color: var(--gold) !important;
      color: var(--dark) !important;
    }

    /* Menu hover underline accent */
    .navbar .nav-link{
      position: relative;
    }
    .navbar .nav-link::after{
      content:""; position:absolute; left: .5rem; right: .5rem; bottom: .35rem;
      height: 2px; background: var(--gold); transform: scaleX(0); transform-origin: left;
      transition: transform .25s ease;
    }
    .navbar .nav-link:hover::after,
    .navbar .nav-link.active::after{ transform: scaleX(1); }

    /* Icons subtle hover */
    .fa, .bi{ opacity: .92; }
    .fa:hover, .bi:hover{ opacity: 1; transform: translateY(-1px); }

    /* Spacing polish inside navbar */
    .navbar .navbar-nav .nav-link{ padding-left: .6rem; padding-right: .6rem; }

    /* Mobile-first tweaks */
    @media (max-width: 991.98px){
      .navbar .navbar-nav .nav-link{ padding-top: .55rem; padding-bottom: .55rem; }
      .navbar .dropdown-menu{
        box-shadow: var(--shadow-sm);
      }
    }

    /* Dark mode (optional) */
    @media (prefers-color-scheme: dark){
      body{ background: #111416; color: #e9ecef; }
      .navbar{
        background: rgba(35,37,38,0.85) !important;
        border-bottom-color: rgba(255,255,255,0.06) !important;
      }
      .navbar.is-scrolled{ background: rgba(35,37,38,0.92) !important; }
      .navbar .navbar-brand, .navbar .nav-link{ color: #e9ecef !important; }
      .dropdown-menu{
        background: #1c1f22;
        box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      }
      .dropdown-item:hover{ background: rgba(255,193,7,0.16); color: #fff; }
      .card{ background: #1a1d20; box-shadow: 0 10px 26px rgba(0,0,0,0.35); }
      .alert{ background: #1a1d20; color: #e9ecef; }
      .navbar .btn-outline-dark{
        background: transparent !important;
        color: #e9ecef !important;
        border-color: var(--gold) !important;
      }
      .navbar .btn-outline-dark:hover{
        background: #0f1113 !important;
        color: #fff !important;
      }
    }
  </style>

  {% block extra_css %}{% endblock %}
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand" href="{% url 'home' %}">Maryama Shop</a>

      <!-- Mobile wishlist + cart: always visible on small screens -->
      <a class="btn btn-outline-dark position-relative ms-auto me-2 d-lg-none" href="{% url 'wishlist' %}" aria-label="Wishlist">
        <i class="fas fa-heart"></i>
        <span class="visually-hidden">Favoris</span>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger wishlist-count" style="display:none">0</span>
      </a>
      
      <a class="btn btn-outline-dark position-relative me-2 d-lg-none" href="{% url 'panier' %}" aria-label="Panier">
        <i class="bi bi-cart3"></i>
        <span class="visually-hidden">Panier</span>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark cart-count" style="display:none">0</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <!-- Liens de gauche -->
        <ul class="navbar-nav ms-3">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">Accueil</a>
          </li>

          <!-- Dropdown Boutique -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="shopDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Boutique
            </a>
            <ul class="dropdown-menu" aria-labelledby="shopDropdown">
              <li><a class="dropdown-item" href="{% url 'boutique' %}">Tous les produits</a></li>
              <li><a class="dropdown-item" href="{% url 'boutique' %}?tri=populaires">Plus populaires</a></li>
              <li><a class="dropdown-item" href="{% url 'boutique' %}?tri=mieux-notes">Mieux notés</a></li>
              <li><a class="dropdown-item" href="{% url 'boutique' %}?tri=nouveautes">Nouveautés</a></li>
            </ul>
          </li>

          <li class="nav-item">
            <a class="nav-link" href="{% url 'about' %}">À propos</a>
          </li>
        </ul>

        <!-- Zone droite -->
        <div class="ms-auto d-flex align-items-center">

          {% if user.is_authenticated %}
            <div class="nav-item dropdown me-3">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#"
                 id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                {% if user.userprofile.avatar %}
                  <img src="{{ user.userprofile.avatar.url }}"
                       alt="Profile" class="rounded-circle me-2"
                       style="width: 32px; height: 32px; object-fit: cover;">
                {% else %}
                  <i class="fas fa-user-circle fa-2x me-2"></i>
                {% endif %}
                <span>{{ user.username }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li class="dropdown-header">
                  <h6 class="mb-0">{{ user.get_full_name|default:user.username }}</h6>
                  <small class="text-muted">{{ user.email }}</small>
                </li>
                <li><hr class="dropdown-divider"></li>

                {% with role=user.userprofile.role|default:'' %}
                  {% if user.is_staff %}
                    <li>
                      <a class="dropdown-item" href="{% url 'admin_dashboard' %}">
                        <i class="fas fa-gauge-high fa-fw me-2"></i> Panneau admin
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'admin_products' %}">
                        <i class="fas fa-box-open fa-fw me-2"></i> Gérer les produits
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item" href="{% url 'admin_profile' %}">
                        <i class="fas fa-user fa-fw me-2"></i> Mon profil
                      </a>
                    </li>
                  {% elif role == 'LIVREUR' %}
                    <li>
                      <a class="dropdown-item" href="{% url 'livreur_dashboard' %}">
                        <i class="fas fa-gauge-high fa-fw me-2"></i> Tableau de bord
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'livreur_profile' %}">
                        <i class="fas fa-user fa-fw me-2"></i> Mon profil
                      </a>
                    </li>
                  {% else %}
                    <li>
                      <a class="dropdown-item" href="{% url 'dashboard' %}">
                        <i class="fas fa-gauge-high fa-fw me-2"></i> Tableau de bord
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'profile' %}">
                        <i class="fas fa-user fa-fw me-2"></i> Mon profil
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'orders' %}">
                        <i class="fas fa-box fa-fw me-2"></i> Mes commandes
                      </a>
                    </li>
                  {% endif %}
                {% endwith %}

                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{% url 'change_password' %}">
                    <i class="fas fa-key fa-fw me-2"></i> Changer le mot de passe
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <form method="post" action="{% url 'logout' %}">{% csrf_token %}
                    <button class="dropdown-item text-danger" type="submit">
                      <i class="fas fa-sign-out-alt fa-fw me-2"></i> Déconnexion
                    </button>
                  </form>
                </li>
              </ul>
            </div>
          {% else %}
            <a class="btn btn-dark me-2" href="{% url 'login_short' %}">Connexion</a>
            <a class="btn btn-outline-dark" href="{% url 'register_short' %}">Inscription</a>
          {% endif %}

          <!-- Desktop cart visible on lg+ -->
          <a class="btn btn-outline-dark position-relative me-2 d-none d-lg-inline-flex" href="{% url 'wishlist' %}" aria-label="Wishlist">
            <i class="fas fa-heart"></i><span class="ms-1">Favoris</span>
            <span id="wishlist-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none">
              0
            </span>
          </a>
          
          <a class="btn btn-outline-dark position-relative me-3 d-none d-lg-inline-flex" href="{% url 'panier' %}" aria-label="Panier">
            <i class="bi bi-cart3"></i><span class="ms-1">Panier</span>
            <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark cart-count" style="display:none">
              {{ cart_count|default:0 }}
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <style>
    /* Responsive fix for user dropdown in navbar */
    .navbar .dropdown-menu[aria-labelledby="userDropdown"] {
      min-width: 16rem;
    }

    @media (max-width: 991.98px) {
      /* On mobile/tablet, dropdown appears in the collapsed navbar flow */
      .navbar-collapse .dropdown-menu[aria-labelledby="userDropdown"] {
        position: static !important;
        float: none;
        width: 100%;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid rgba(0,0,0,0.08);
        box-shadow: none;
        max-height: 60vh;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      .navbar-collapse .dropdown-menu[aria-labelledby="userDropdown"] .dropdown-item {
        white-space: normal;
        padding: 0.7rem 1rem;
      }
      
      .navbar-collapse .dropdown-header {
        padding: 0.75rem 1rem 0.5rem;
      }
      
      .navbar-collapse .dropdown-header small {
        display: block;
        white-space: normal;
        word-break: break-word;
      }

      /* Ensure the dropdown toggle (avatar + username) is properly sized */
      .navbar-collapse .nav-link.dropdown-toggle {
        padding: 0.75rem 0;
      }
    }

    @media (min-width: 992px) {
      /* On desktop, dropdown is absolutely positioned */
      .navbar .dropdown-menu[aria-labelledby="userDropdown"] {
        position: absolute;
        right: 0;
        left: auto;
        margin-top: 0.5rem;
      }
    }
  </style>

  <!-- Messages -->
  <div class="container mt-3">
    {% if messages %}
      <div>
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Contenu -->
  <main>
    {% block content %}{% endblock %}
  </main>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Fix body offset based on dynamic navbar height + shadow on scroll
    (function() {
      const nav = document.querySelector('.navbar');
      const applyOffset = () => {
        if (!nav) return;
        const h = nav.offsetHeight || 72;
        document.body.style.setProperty('--nav-offset', h + 'px');
      };
      applyOffset();
      window.addEventListener('resize', applyOffset);
      window.addEventListener('orientationchange', applyOffset);

      const onScroll = () => {
        if (!nav) return;
        if (window.scrollY > 2) nav.classList.add('is-scrolled');
        else nav.classList.remove('is-scrolled');
      };
      onScroll();
      document.addEventListener('scroll', onScroll, { passive: true });
    })();
  </script>

  <script>
    // Harmonise le JS du badge avec #cart-count
    (function() {
      function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }
      const csrftoken = getCookie('csrftoken');
      const cartEls = document.querySelectorAll('#cart-count, .cart-count');

      window.updateCartBadge = function(count) {
        const n = Number(count) || 0;
        cartEls.forEach(el => {
          el.textContent = n;
          el.style.display = n > 0 ? 'inline' : 'none';
          el.setAttribute('aria-label', `Articles au panier: ${n}`);
        });
      };

      // Update wishlist badge
      window.updateWishlistBadge = function() {
        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const count = wishlist.length;
        const wishlistEls = document.querySelectorAll('#wishlist-count, .wishlist-count');
        wishlistEls.forEach(el => {
          el.textContent = count;
          el.style.display = count > 0 ? 'inline' : 'none';
          el.setAttribute('aria-label', `Produits favoris: ${count}`);
        });
      };

      // Initialize wishlist badge on page load
      updateWishlistBadge();

      window.ajouterAuPanier = async function(productId, url) {
        try {
          const endpoint = url || '/panier/add/';
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ product_id: productId, quantity: 1 })
          });
          const data = await res.json();
          if (typeof data.cart_count !== 'undefined') updateCartBadge(data.cart_count);
          return false;
        } catch (e) { console.error(e); return false; }
      };
    })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>