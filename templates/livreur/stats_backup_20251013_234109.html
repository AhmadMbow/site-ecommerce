{% extends "livreur/base_livreur.html" %}

{% block title %}Statistiques - DashLivr{% endblock %}
{% block header %}Mes Statistiques{% endblock %}

{% block content %}
<!-- Variables CSS calculées côté serveur -->
<style>
:root {
  {% if stats.count_all > 0 %}
    --pending-width: {% widthratio stats.pending stats.count_all 100 %}%;
    --progress-width: {% widthratio stats.in_progress stats.count_all 100 %}%;
    --completed-width: {% widthratio stats.completed stats.count_all 100 %}%;
    --completion-rate: {% widthratio stats.completed stats.count_all 100 %}%;
  {% else %}
    --pending-width: 0%;
    --progress-width: 0%;
    --completed-width: 0%;
    --completion-rate: 0%;
  {% endif %}
}
</style>

<div class="content-card" style="padding: 1.5rem;">
  
  <!-- Statistiques générales -->
  <div class="stats-overview mb-5">
    <h4 class="mb-4">Vue d'ensemble</h4>
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-number">{{ stats.count_all }}</div>
        <div class="stat-label">Commandes totales</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.completed }}</div>
        <div class="stat-label">Commandes livrées</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.delivered_today }}</div>
        <div class="stat-label">Livrées aujourd'hui</div>
      </div>
      <div class="stat-item">
        <div class="stat-number">{{ stats.revenue_today|floatformat:0 }} FCFA</div>
        <div class="stat-label">Revenus du jour par livraison réussie</div>
      </div>
    </div>
  </div>

  <!-- Revenus détaillés -->
  <div class="revenue-breakdown mb-5">
    <h4 class="mb-4">Revenus de livraison</h4>
    <div class="revenue-cards">
      <div class="revenue-card">
        <div class="revenue-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="revenue-info">
          <div class="revenue-amount">{{ stats.revenue_total|floatformat:0 }} FCFA</div>
          <div class="revenue-label">Total gagné</div>
        </div>
      </div>
      
      <div class="revenue-card">
        <div class="revenue-icon">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="revenue-info">
          <div class="revenue-amount">{{ stats.revenue_today|floatformat:0 }} FCFA</div>
          <div class="revenue-label">Aujourd'hui</div>
        </div>
      </div>
      
      <div class="revenue-card">
        <div class="revenue-icon">
          <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="revenue-info">
          <div class="revenue-amount">{{ stats.revenue_this_month|floatformat:0 }} FCFA</div>
          <div class="revenue-label">Ce mois</div>
        </div>
      </div>
      
      <div class="revenue-card">
        <div class="revenue-icon">
          <i class="fas fa-truck"></i>
        </div>
        <div class="revenue-info">
          <div class="revenue-amount">{{ stats.frais_livraison|floatformat:0 }} FCFA</div>
          <div class="revenue-label">Par livraison</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Répartition par statut -->
  <div class="status-breakdown mb-5">
    <h4 class="mb-4">Répartition par statut</h4>
    <div class="status-bars">
      <div class="status-bar">
        <div class="status-info">
          <span class="status-name">En attente</span>
          <span class="status-count">{{ stats.pending }}</span>
        </div>
        <div class="progress">
          <div class="progress-bar bg-warning pending-bar"></div>
        </div>
      </div>
      
      <div class="status-bar">
        <div class="status-info">
          <span class="status-name">En cours</span>
          <span class="status-count">{{ stats.in_progress }}</span>
        </div>
        <div class="progress">
          <div class="progress-bar bg-info progress-bar-custom"></div>
        </div>
      </div>
      
      <div class="status-bar">
        <div class="status-info">
          <span class="status-name">Livrées</span>
          <span class="status-count">{{ stats.completed }}</span>
        </div>
        <div class="progress">
          <div class="progress-bar bg-success completed-bar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Évolution mensuelle -->
  {% if monthly_stats %}
  <div class="monthly-evolution">
    <h4 class="mb-4">Évolution mensuelle</h4>
    <div class="monthly-chart">
      {% for month_data in monthly_stats %}
      <div class="month-item">
        <div class="month-bar">
          <div class="bar" data-height="{{ month_data.count|default:0 }}"></div>
        </div>
        <div class="month-label">{{ month_data.month|date:"M" }}</div>
        <div class="month-count">{{ month_data.count }} livraisons</div>
        <div class="month-revenue">{{ month_data.revenue|floatformat:0 }} FCFA</div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Taux de performance -->
  <div class="performance mt-5">
    <h4 class="mb-4">Performance</h4>
    <div class="performance-grid">
      <div class="perf-item">
        <div class="perf-label">Taux de livraison</div>
        <div class="perf-value completion-rate-display">
          {% if stats.count_all > 0 %}
            {% widthratio stats.completed stats.count_all 100 %}%
          {% else %}
            0%
          {% endif %}
        </div>
      </div>
      <div class="perf-item">
        <div class="perf-label">Commandes en cours</div>
        <div class="perf-value">{{ stats.in_progress }}</div>
      </div>
      <div class="perf-item">
        <div class="perf-label">Moyenne par jour</div>
        <div class="perf-value">
          {% if stats.completed > 0 %}
            {{ stats.revenue_today|floatformat:0 }} FCFA
          {% else %}
            0 FCFA
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.stat-item {
  text-align: center;
  padding: 2rem 1rem;
  background: linear-gradient(135deg, var(--primary), var(--primary-600));
  color: white;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(11, 107, 203, 0.2);
}

.stat-number {
  font-size: 2.5rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  opacity: 0.9;
}

/* Nouveaux styles pour les revenus */
.revenue-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.revenue-card {
  display: flex;
  align-items: center;
  padding: 1.5rem;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.revenue-icon {
  width: 60px;
  height: 60px;
  border-radius: 12px;
  background: linear-gradient(135deg, #28a745, #20c997);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  color: white;
  font-size: 1.5rem;
}

.revenue-amount {
  font-size: 1.5rem;
  font-weight: bold;
  color: #28a745;
  margin-bottom: 0.25rem;
}

.revenue-label {
  color: var(--muted);
  font-size: 0.9rem;
}

.status-bars {
  display: grid;
  gap: 1rem;
}

.status-bar {
  padding: 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
}

.status-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.status-name {
  font-weight: 500;
}

.status-count {
  font-weight: 600;
}

.progress {
  height: 8px;
  background-color: var(--border);
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar {
  height: 100%;
  transition: width 0.6s ease;
}

.pending-bar {
  width: var(--pending-width);
}

.progress-bar-custom {
  width: var(--progress-width);
}

.completed-bar {
  width: var(--completed-width);
}

.bg-warning { background-color: #ffc107; }
.bg-info { background-color: #17a2b8; }
.bg-success { background-color: #28a745; }

.monthly-chart {
  display: flex;
  align-items: end;
  gap: 1rem;
  padding: 2rem;
  background: var(--bg);
  border-radius: 8px;
  min-height: 200px;
}

.month-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.month-bar {
  height: 100px;
  display: flex;
  align-items: end;
  justify-content: center;
}

.bar {
  width: 20px;
  background: var(--primary);
  border-radius: 4px 4px 0 0;
  min-height: 5px;
  transition: height 0.6s ease;
}

.month-label {
  font-size: 0.8rem;
  color: var(--muted);
  text-transform: uppercase;
}

.month-count {
  font-weight: 600;
  font-size: 0.8rem;
}

.month-revenue {
  font-size: 0.75rem;
  color: #28a745;
  font-weight: 600;
}

.performance-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
}

.perf-item {
  padding: 1.5rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  text-align: center;
}

.perf-label {
  color: var(--muted);
  margin-bottom: 0.5rem;
}

.perf-value {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary);
}

.mb-3 { margin-bottom: 1rem; }
.mb-4 { margin-bottom: 1.5rem; }
.mb-5 { margin-bottom: 2rem; }
.mt-5 { margin-top: 2rem; }

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
  
  .revenue-cards {
    grid-template-columns: 1fr;
  }
  
  .monthly-chart {
    overflow-x: auto;
  }
  
  .performance-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
// Animation des barres mensuelles
document.addEventListener('DOMContentLoaded', function() {
  const bars = document.querySelectorAll('.bar[data-height]');
  bars.forEach(bar => {
    const height = parseInt(bar.getAttribute('data-height')) || 0;
    const calculatedHeight = Math.max(5, height * 10); // Min 5px, max basé sur la valeur
    setTimeout(() => {
      bar.style.height = calculatedHeight + 'px';
    }, 100);
  });
});
</script>
{% endblock %}