{% extends "livreur/base_livreur.html" %}
{% block title %}Carte des livraisons{% endblock %}
{% block header %}Carte Interactive{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
/* Map Container */
.map-wrapper {
  position: relative;
  height: calc(100vh - 200px);
  min-height: 500px;
  border-radius: var(--border-radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  background: #f0f0f0; /* Fond gris pour voir si le container existe */
}

#deliveryMap {
  width: 100% !important;
  height: 100% !important;
  position: relative;
  z-index: 1;
  background: #e5e7eb; /* Fond visible m√™me sans tuiles */
}

/* Stats Grid */
.map-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.map-stat-card {
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--border-radius-lg);
  padding: 1.5rem;
  text-align: center;
  position: relative;
  overflow: hidden;
  transition: all var(--transition-normal);
  animation: slideUp 0.5s ease-out backwards;
}

.map-stat-card:nth-child(1) { animation-delay: 0.1s; }
.map-stat-card:nth-child(2) { animation-delay: 0.2s; }
.map-stat-card:nth-child(3) { animation-delay: 0.3s; }
.map-stat-card:nth-child(4) { animation-delay: 0.4s; }

.map-stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg);
}

.map-stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.stat-icon {
  width: 50px;
  height: 50px;
  margin: 0 auto 1rem;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.5rem;
  box-shadow: var(--shadow-md);
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  line-height: 1;
}

.stat-label {
  color: var(--text-secondary);
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Map Controls Overlay */
.map-controls {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.map-control-panel {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: var(--border-radius-md);
  padding: 1rem;
  box-shadow: var(--shadow-lg);
  min-width: 250px;
  max-width: 300px;
}

[data-theme="dark"] .map-control-panel {
  background: rgba(30, 41, 59, 0.95);
}

.control-title {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.control-title i {
  color: var(--primary);
}

.filter-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.filter-btn {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.625rem 0.875rem;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-sm);
  background: var(--surface-secondary);
  color: var(--text-primary);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.filter-btn:hover {
  background: var(--surface-hover);
  border-color: var(--primary);
  transform: translateX(4px);
}

.filter-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: transparent;
}

.filter-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
  padding: 0 0.5rem;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 700;
}

.filter-btn.active .filter-badge {
  background: rgba(255, 255, 255, 0.3);
}

/* Action Buttons */
.map-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.map-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 50%;
  color: var(--text-primary);
  font-size: 1.125rem;
  cursor: pointer;
  transition: all var(--transition-normal);
  box-shadow: var(--shadow-md);
}

[data-theme="dark"] .map-action-btn {
  background: rgba(30, 41, 59, 0.95);
  border-color: rgba(255, 255, 255, 0.1);
}

.map-action-btn:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-lg);
  color: var(--primary);
}

.map-action-btn.active {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  border-color: transparent;
}

/* Legend */
.map-legend {
  position: absolute;
  bottom: 1rem;
  right: 1rem;
  z-index: 1000;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px);
  padding: 1rem;
  border-radius: var(--border-radius-md);
  box-shadow: var(--shadow-lg);
  min-width: 200px;
}

[data-theme="dark"] .map-legend {
  background: rgba(30, 41, 59, 0.95);
}

.legend-title {
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-items {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.legend-marker {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 3px solid white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.marker-pending {
  background: #f59e0b;
}

.marker-progress {
  background: #3b82f6;
}

.marker-delivered {
  background: #10b981;
}

.marker-current {
  background: #ef4444;
}

/* Custom Popup */
.custom-popup {
  font-family: inherit;
}

.popup-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--border-color);
}

.popup-title {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
}

.popup-status {
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  padding: 0.25rem 0.625rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.popup-status.pending {
  background: rgba(245, 158, 11, 0.15);
  color: #f59e0b;
}

.popup-status.progress {
  background: rgba(59, 130, 246, 0.15);
  color: #3b82f6;
}

.popup-status.delivered {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
}

.popup-info {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.popup-info-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.popup-info-item i {
  color: var(--primary);
  width: 16px;
  text-align: center;
}

.popup-actions {
  display: flex;
  gap: 0.5rem;
}

.popup-btn {
  flex: 1;
  padding: 0.5rem;
  border-radius: var(--border-radius-sm);
  border: none;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  text-decoration: none;
  text-align: center;
  display: inline-block;
}

.popup-btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
}

.popup-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
}

.popup-btn-secondary {
  background: var(--surface-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.popup-btn-secondary:hover {
  background: var(--surface-hover);
  border-color: var(--primary);
}

/* Loading State */
.map-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(16px);
  padding: 2rem;
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-xl);
  text-align: center;
}

[data-theme="dark"] .map-loading {
  background: rgba(30, 41, 59, 0.95);
}

.map-loading.hidden {
  display: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  margin: 0 auto 1rem;
  border: 4px solid var(--border-color);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

/* Animations */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .map-wrapper {
    height: calc(100vh - 250px);
  }
  
  .map-controls {
    left: 0.5rem;
    right: 0.5rem;
    top: 0.5rem;
  }
  
  .map-control-panel {
    min-width: auto;
    max-width: none;
  }
  
  .map-legend {
    left: 0.5rem;
    right: 0.5rem;
    bottom: 0.5rem;
  }
  
  .map-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 480px) {
  .map-stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-icon {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
}
</style>
{% endblock %}

{% block content %}
<!-- Stats Grid -->
<div class="map-stats-grid">
  <div class="map-stat-card">
    <div class="stat-icon">
      <i class="fas fa-layer-group"></i>
    </div>
    <div class="stat-value">{{ stats.count_all|default:0 }}</div>
    <div class="stat-label">Total Commandes</div>
  </div>
  
  <div class="map-stat-card">
    <div class="stat-icon">
      <i class="fas fa-map-marker-alt"></i>
    </div>
    <div class="stat-value">{{ orders_with_coords|length|default:0 }}</div>
    <div class="stat-label">Avec GPS</div>
  </div>
  
  <div class="map-stat-card">
    <div class="stat-icon">
      <i class="fas fa-clock"></i>
    </div>
    <div class="stat-value">{{ stats.pending|default:0 }}</div>
    <div class="stat-label">En Attente</div>
  </div>
  
  <div class="map-stat-card">
    <div class="stat-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="stat-value">{{ stats.completed|default:0 }}</div>
    <div class="stat-label">Livr√©es</div>
  </div>
</div>

<!-- Map Container -->
<div class="map-wrapper">
  <!-- Loading State -->
  <div class="map-loading" id="mapLoading">
    <div class="loading-spinner"></div>
    <p style="color: var(--text-secondary); margin: 0;">Chargement de la carte...</p>
  </div>
  
  <!-- Map Controls -->
  <div class="map-controls">
    <!-- Filter Panel -->
    <div class="map-control-panel" id="filterPanel">
      <div class="control-title">
        <i class="fas fa-filter"></i>
        Filtrer par statut
      </div>
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">
          <span>
            <i class="fas fa-list"></i>
            Toutes
          </span>
          <span class="filter-badge">{{ orders_with_coords|length|default:0 }}</span>
        </button>
        <button class="filter-btn" data-filter="EN_ATTENTE">
          <span>
            <i class="fas fa-clock"></i>
            En attente
          </span>
          <span class="filter-badge" id="badge-pending">0</span>
        </button>
        <button class="filter-btn" data-filter="EN_COURS">
          <span>
            <i class="fas fa-truck"></i>
            En cours
          </span>
          <span class="filter-badge" id="badge-progress">0</span>
        </button>
        <button class="filter-btn" data-filter="LIVREE">
          <span>
            <i class="fas fa-check-circle"></i>
            Livr√©es
          </span>
          <span class="filter-badge" id="badge-delivered">0</span>
        </button>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="map-actions">
      <button class="map-action-btn" id="locateBtn" title="Ma position">
        <i class="fas fa-crosshairs"></i>
      </button>
      <button class="map-action-btn" id="centerBtn" title="Centrer la carte">
        <i class="fas fa-compress"></i>
      </button>
      <button class="map-action-btn" id="refreshBtn" title="Actualiser">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>
  
  <!-- Legend -->
  <div class="map-legend">
    <div class="legend-title">
      <i class="fas fa-info-circle"></i>
      L√©gende
    </div>
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-marker marker-pending"></div>
        <span>En attente</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-progress"></div>
        <span>En cours</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-delivered"></div>
        <span>Livr√©e</span>
      </div>
      <div class="legend-item">
        <div class="legend-marker marker-current"></div>
        <span>Ma position</span>
      </div>
    </div>
  </div>
  
  <!-- Map -->
  <div id="deliveryMap"></div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// Configuration
const CONFIG = {
  defaultCenter: [14.6928, -17.4467], // Dakar
  defaultZoom: 12,
  maxZoom: 18,
  refreshInterval: 30000, // 30s
  clusterRadius: 50,
  markerColors: {
    EN_ATTENTE: '#f59e0b',
    EN_COURS: '#3b82f6',
    LIVREE: '#10b981',
    current: '#ef4444'
  }
};

// State
let map, markers = {}, markerCluster, currentLocationMarker;
let activeFilter = 'all';
let userLocation = null;

// Initialize Map
function initMap() {
  console.log('üó∫Ô∏è Initialisation de la carte...');
  
  // Check if map container exists
  const mapContainer = document.getElementById('deliveryMap');
  if (!mapContainer) {
    console.error('‚ùå Container #deliveryMap introuvable !');
    return;
  }
  console.log('‚úÖ Container trouv√©:', mapContainer);
  
  // Create map
  try {
    map = L.map('deliveryMap', {
      center: CONFIG.defaultCenter,
      zoom: CONFIG.defaultZoom,
      zoomControl: false
    });
    console.log('‚úÖ Carte Leaflet cr√©√©e');
  } catch (error) {
    console.error('‚ùå Erreur cr√©ation carte:', error);
    const loadingEl = document.getElementById('mapLoading');
    if (loadingEl) {
      loadingEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Erreur de chargement de la carte</p>';
    }
    return;
  }
  
  // Add tile layer with multiple providers
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: CONFIG.maxZoom
  });
  
  const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri',
    maxZoom: CONFIG.maxZoom
  });
  
  // Hide loading when tiles are loaded
  osm.on('load', () => {
    const loadingEl = document.getElementById('mapLoading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
      console.log('‚úÖ Carte charg√©e, loading cach√©');
    }
    // Force map to recalculate size
    setTimeout(() => {
      if (map) {
        map.invalidateSize();
        console.log('‚úÖ Taille de carte recalcul√©e');
      }
    }, 100);
  });
  
  osm.addTo(map);
  
  // Force initial size calculation
  setTimeout(() => {
    if (map) {
      map.invalidateSize();
      console.log('‚úÖ Taille initiale calcul√©e');
    }
  }, 250);
  
  // Layer control
  L.control.layers({
    'Plan': osm,
    'Satellite': satellite
  }, null, { position: 'topright' }).addTo(map);
  
  // Zoom control (bottom right)
  L.control.zoom({ position: 'bottomright' }).addTo(map);
  
  // Initialize marker cluster
  markerCluster = L.markerClusterGroup({
    maxClusterRadius: CONFIG.clusterRadius,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    iconCreateFunction: function(cluster) {
      const count = cluster.getChildCount();
      let className = 'marker-cluster-';
      
      if (count < 10) className += 'small';
      else if (count < 50) className += 'medium';
      else className += 'large';
      
      return L.divIcon({
        html: `<div><span>${count}</span></div>`,
        className: 'marker-cluster ' + className,
        iconSize: L.point(40, 40)
      });
    }
  });
  
  map.addLayer(markerCluster);
  
  // Load markers
  loadMarkers();
  
  // Auto-refresh
  setInterval(refreshMarkers, CONFIG.refreshInterval);
}

// Create custom marker icon
function createMarkerIcon(status) {
  const color = CONFIG.markerColors[status] || CONFIG.markerColors.EN_ATTENTE;
  
  return L.divIcon({
    html: `
      <div style="
        background: ${color};
        width: 32px;
        height: 32px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <i class="fas fa-${status === 'LIVREE' ? 'check' : status === 'EN_COURS' ? 'truck' : 'clock'}" 
           style="
             color: white;
             font-size: 14px;
             transform: rotate(45deg);
           "></i>
      </div>
    `,
    className: 'custom-marker',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
}

// Create popup content
function createPopupContent(order) {
  const statusBadge = {
    'EN_ATTENTE': '<span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚è±Ô∏è En attente</span>',
    'EN_COURS': '<span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">üöö En cours</span>',
    'LIVREE': '<span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">‚úÖ Livr√©e</span>'
  };
  
  return `
    <div class="custom-popup">
      <div class="popup-header">
        <h4 style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-primary);">
          Commande #${order.id}
        </h4>
        ${statusBadge[order.statut]}
      </div>
      
      <div class="popup-content">
        <div class="popup-info">
          <i class="fas fa-user"></i>
          <div>
            <strong>${order.client}</strong>
            <small>${order.phone || 'N/A'}</small>
          </div>
        </div>
        
        <div class="popup-info">
          <i class="fas fa-map-marker-alt"></i>
          <div>
            <strong>${order.adresse}</strong>
            <small>Latitude: ${order.lat.toFixed(4)}, Longitude: ${order.lng.toFixed(4)}</small>
          </div>
        </div>
        
        ${order.note ? `
        <div class="popup-info">
          <i class="fas fa-sticky-note"></i>
          <div>
            <small style="color: var(--text-secondary);">${order.note}</small>
          </div>
        </div>
        ` : ''}
      </div>
      
      <div class="popup-actions">
        <a href="/livreur/commande/${order.id}/" class="popup-btn popup-btn-primary">
          <i class="fas fa-eye"></i>
          Voir d√©tails
        </a>
        <button class="popup-btn popup-btn-secondary" onclick="openRoute(${order.lat}, ${order.lng})">
          <i class="fas fa-route"></i>
          Itin√©raire
        </button>
      </div>
    </div>
  `;
}

// Load markers from Django data
function loadMarkers() {
  const orders = [
    {% for order in orders_with_coords %}
    {
      id: {{ order.id }},
      lat: {{ order.latitude }},
      lng: {{ order.longitude }},
      statut: '{{ order.statut }}',
      client: '{{ order.user.get_full_name|default:order.user.username|escapejs }}',
      phone: '{{ order.user.userprofile.phone|default:""|escapejs }}',
      adresse: '{{ order.adresse_gps|default:"Adresse non renseign√©e"|escapejs }}',
      note: ''
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  // Update filter badges
  const counts = {
    EN_ATTENTE: 0,
    EN_COURS: 0,
    LIVREE: 0
  };
  
  orders.forEach(order => {
    counts[order.statut]++;
    
    const marker = L.marker([order.lat, order.lng], {
      icon: createMarkerIcon(order.statut)
    });
    
    marker.bindPopup(createPopupContent(order), {
      maxWidth: 320,
      className: 'leaflet-custom-popup'
    });
    
    marker.orderData = order;
    markers[order.id] = marker;
    markerCluster.addLayer(marker);
  });
  
  // Update badges
  document.getElementById('badge-pending').textContent = counts.EN_ATTENTE;
  document.getElementById('badge-progress').textContent = counts.EN_COURS;
  document.getElementById('badge-delivered').textContent = counts.LIVREE;
  
  // Fit bounds if markers exist
  if (orders.length > 0) {
    const bounds = markerCluster.getBounds();
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
  }
}

// Filter markers
function filterMarkers(status) {
  activeFilter = status;
  
  markerCluster.clearLayers();
  
  Object.values(markers).forEach(marker => {
    if (status === 'all' || marker.orderData.statut === status) {
      markerCluster.addLayer(marker);
    }
  });
  
  // Update UI
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.filter === status);
  });
}

// Refresh markers (AJAX)
async function refreshMarkers() {
  try {
    const response = await fetch(window.location.href, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    
    if (response.ok) {
      // In production, parse response and update markers
      console.log('‚úÖ Markers refreshed');
    }
  } catch (error) {
    console.error('‚ùå Refresh error:', error);
  }
}

// Get user location
function locateUser() {
  const btn = document.getElementById('locateBtn');
  btn.classList.add('loading');
  
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = [position.coords.latitude, position.coords.longitude];
        
        // Remove old marker
        if (currentLocationMarker) {
          map.removeLayer(currentLocationMarker);
        }
        
        // Add new marker
        currentLocationMarker = L.marker(userLocation, {
          icon: L.divIcon({
            html: `
              <div style="
                background: ${CONFIG.markerColors.current};
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 4px solid white;
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 0 0 8px rgba(239, 68, 68, 0.2);
                animation: pulse 2s infinite;
              "></div>
            `,
            className: 'current-location-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(map);
        
        currentLocationMarker.bindPopup('üìç Ma position actuelle');
        
        // Center map
        map.setView(userLocation, 15);
        
        btn.classList.remove('loading');
        showToast('Position trouv√©e', 'success');
      },
      (error) => {
        btn.classList.remove('loading');
        showToast('Impossible d\'obtenir votre position', 'error');
        console.error('Geolocation error:', error);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  } else {
    btn.classList.remove('loading');
    showToast('G√©olocalisation non support√©e', 'error');
  }
}

// Open route in Google Maps
function openRoute(lat, lng) {
  if (userLocation) {
    const url = `https://www.google.com/maps/dir/${userLocation[0]},${userLocation[1]}/${lat},${lng}`;
    window.open(url, '_blank');
  } else {
    const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
    window.open(url, '_blank');
    showToast('Obtenez d\'abord votre position pour l\'itin√©raire', 'info');
  }
}

// Center map on all markers
function centerMap() {
  if (markerCluster.getLayers().length > 0) {
    const bounds = markerCluster.getBounds();
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
  }
}

// Toast notification
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
    <span>${message}</span>
  `;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ DOM charg√©, initialisation...');
  console.log('üì¶ Leaflet disponible:', typeof L !== 'undefined');
  console.log('üìç Container existe:', !!document.getElementById('deliveryMap'));
  
  initMap();
  
  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      filterMarkers(btn.dataset.filter);
    });
  });
  
  // Action buttons
  document.getElementById('locateBtn').addEventListener('click', locateUser);
  document.getElementById('centerBtn').addEventListener('click', centerMap);
  document.getElementById('refreshBtn').addEventListener('click', () => {
    const btn = document.getElementById('refreshBtn');
    btn.style.animation = 'spin 1s linear';
    refreshMarkers();
    setTimeout(() => btn.style.animation = '', 1000);
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      document.querySelector('.filter-btn').focus();
    }
    if (e.ctrlKey && e.key === 'l') {
      e.preventDefault();
      locateUser();
    }
  });
});

// Animation styles
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}