{% extends "adminpanel/base_admin.html" %}
{% load static %}
{% block title %}Commande #{{ order.id }} - Détails{% endblock %}
{% block header %}Détail de la Commande{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    --card-shadow-hover: 0 8px 32px rgba(102, 126, 234, 0.2);
    --radius: 1rem;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  body {
    background: linear-gradient(135deg, rgba(102,126,234,0.02), rgba(118,75,162,0.02));
  }

  /* Order Header */
  .order-header {
    background: white;
    padding: 2rem;
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
  }

  .order-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: var(--primary-gradient);
  }

  .order-header::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(102,126,234,0.1), transparent);
    border-radius: 50%;
  }

  .order-number {
    font-size: 2rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }

  .order-meta {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .meta-item-inline {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
    font-size: 0.95rem;
  }

  .meta-item-inline i {
    color: #667eea;
    font-size: 1.1rem;
  }

  /* Status Badge Ultra */
  .status-badge-ultra {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    border-radius: 2rem;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .status-en_cours {
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.15));
    color: #3b82f6;
    border: 2px solid rgba(59,130,246,0.3);
  }

  .status-livree {
    background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.15));
    color: #10b981;
    border: 2px solid rgba(16,185,129,0.3);
  }

  .status-annulee {
    background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.15));
    color: #ef4444;
    border: 2px solid rgba(239,68,68,0.3);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-action-modern {
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    font-size: 0.95rem;
  }

  .btn-primary-gradient {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 4px 12px rgba(102,126,234,0.3);
  }

  .btn-primary-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    color: white;
  }

  .btn-outline-modern {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
  }

  .btn-outline-modern:hover {
    background: var(--primary-gradient);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
  }

  .btn-danger-modern {
    background: white;
    color: #ef4444;
    border: 2px solid #ef4444;
  }

  .btn-danger-modern:hover {
    background: var(--danger-gradient);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
  }

  /* Main Content Grid */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1200px) {
    .content-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Card Ultra */
  .card-ultra-detail {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    overflow: hidden;
    transition: var(--transition);
  }

  .card-ultra-detail:hover {
    box-shadow: var(--card-shadow-hover);
  }

  .card-header-detail {
    padding: 1.5rem;
    border-bottom: 2px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .card-header-detail h3 {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1a1f26;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .card-header-detail h3 i {
    color: #667eea;
  }

  .card-body-detail {
    padding: 1.5rem;
  }

  /* Product Item */
  .product-item {
    display: flex;
    gap: 1.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(102,126,234,0.03), rgba(118,75,162,0.03));
    border-radius: 0.75rem;
    margin-bottom: 1rem;
    transition: var(--transition);
    border: 2px solid transparent;
  }

  .product-item:hover {
    border-color: rgba(102,126,234,0.2);
    transform: translateX(5px);
    background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
  }

  .product-image {
    width: 80px;
    height: 80px;
    border-radius: 0.75rem;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .product-image-placeholder {
    width: 80px;
    height: 80px;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .product-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .product-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1a1f26;
    margin-bottom: 0.5rem;
  }

  .product-meta {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .product-meta-item {
    display: flex;
    flex-direction: column;
  }

  .product-meta-label {
    font-size: 0.75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
  }

  .product-meta-value {
    font-size: 1rem;
    font-weight: 700;
    color: #1a1f26;
  }

  .product-total {
    text-align: right;
  }

  .product-total-amount {
    font-size: 1.5rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Order Summary */
  .order-summary {
    background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));
    padding: 1.5rem;
    border-radius: 0.75rem;
    margin-top: 1.5rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  .summary-row:last-child {
    border-bottom: none;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 2px solid rgba(102,126,234,0.2);
  }

  .summary-label {
    font-size: 0.95rem;
    color: #64748b;
    font-weight: 600;
  }

  .summary-value {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1a1f26;
  }

  .summary-total {
    font-size: 1.5rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Info Card */
  .info-card {
    padding: 1.5rem;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    margin-bottom: 1.5rem;
  }

  .info-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }

  .info-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .info-label {
    font-size: 0.75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .info-label i {
    color: #667eea;
  }

  .info-value {
    font-size: 1rem;
    color: #1a1f26;
    font-weight: 600;
  }

  .client-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));
    border-radius: 0.75rem;
    margin-top: 0.5rem;
  }

  .client-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(102,126,234,0.3);
  }

  .client-details h4 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1a1f26;
    margin: 0 0 0.25rem 0;
  }

  .client-details p {
    font-size: 0.85rem;
    color: #64748b;
    margin: 0;
  }

  /* Map Container */
  .map-container {
    border-radius: 0.75rem;
    overflow: hidden;
    height: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-top: 1rem;
  }

  #orderMap {
    width: 100%;
    height: 100%;
  }

  /* Timeline */
  .timeline {
    position: relative;
    padding-left: 2rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(180deg, #667eea, #764ba2);
  }

  .timeline-item {
    position: relative;
    margin-bottom: 2rem;
    padding-left: 1.5rem;
  }

  .timeline-item::before {
    content: '';
    position: absolute;
    left: -1.7rem;
    top: 0.25rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: white;
    border: 3px solid #667eea;
    box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
  }

  .timeline-item.active::before {
    background: #667eea;
    box-shadow: 0 0 0 4px rgba(102,126,234,0.2), 0 0 12px rgba(102,126,234,0.4);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .timeline-content {
    background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));
    padding: 1rem;
    border-radius: 0.75rem;
    border-left: 3px solid #667eea;
  }

  .timeline-title {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1a1f26;
    margin-bottom: 0.25rem;
  }

  .timeline-date {
    font-size: 0.8rem;
    color: #94a3b8;
  }

  /* GPS Info Card */
  .gps-card {
    background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));
    padding: 1.5rem;
    border-radius: 0.75rem;
    border: 2px solid rgba(16,185,129,0.2);
    margin-top: 1rem;
  }

  .gps-coordinates {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .gps-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--success-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(16,185,129,0.3);
  }

  .gps-values {
    flex: 1;
  }

  .gps-label {
    font-size: 0.75rem;
    color: #059669;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .gps-value {
    font-size: 1rem;
    font-weight: 700;
    color: #1a1f26;
    font-family: 'Courier New', monospace;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
  }

  .empty-state i {
    font-size: 3rem;
    color: #e3e7f0;
    margin-bottom: 1rem;
  }

  .empty-state h4 {
    font-size: 1.2rem;
    font-weight: 700;
    color: #64748b;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: #94a3b8;
  }

  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animated {
    animation: fadeInUp 0.5s ease backwards;
  }

  .animated:nth-child(1) { animation-delay: 0.05s; }
  .animated:nth-child(2) { animation-delay: 0.1s; }
  .animated:nth-child(3) { animation-delay: 0.15s; }
  .animated:nth-child(4) { animation-delay: 0.2s; }

  /* Print Styles */
  @media print {
    .action-buttons,
    .btn-action-modern {
      display: none !important;
    }
  }

  /* Badge with icon */
  .badge-with-icon {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .badge-info {
    background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.15));
    color: #3b82f6;
  }

  .badge-success {
    background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.15));
    color: #10b981;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .order-header {
      padding: 1.5rem;
    }

    .order-number {
      font-size: 1.5rem;
    }

    .order-meta {
      flex-direction: column;
      gap: 1rem;
    }

    .action-buttons {
      flex-direction: column;
    }

    .btn-action-modern {
      width: 100%;
      justify-content: center;
    }

    .product-item {
      flex-direction: column;
      gap: 1rem;
    }

    .product-meta {
      flex-direction: column;
      gap: 0.75rem;
    }

    .product-total {
      text-align: left;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Order Header -->
<div class="order-header animated">
  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
    <div>
      <div class="order-number">
        <i class="bi bi-receipt"></i>
        Commande #{{ order.id }}
      </div>
      <div class="order-meta">
        <div class="meta-item-inline">
          <i class="bi bi-calendar3"></i>
          <span>{{ order.date_commande|date:"d/m/Y à H:i" }}</span>
        </div>
        <div class="meta-item-inline">
          <i class="bi bi-person"></i>
          <span>{{ order.user.get_full_name|default:order.user.username }}</span>
        </div>
        <span class="status-badge-ultra status-{{ order.statut|lower|cut:" " }}">
          <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>
          {{ order.statut|default:"En cours" }}
        </span>
      </div>
    </div>
    
    <div class="action-buttons">
      <a href="{% url 'admin_orders' %}" class="btn-action-modern btn-outline-modern">
        <i class="bi bi-arrow-left"></i>
        Retour
      </a>
      <button onclick="window.print()" class="btn-action-modern btn-primary-gradient">
        <i class="bi bi-printer"></i>
        Imprimer
      </button>
      <button onclick="exportOrder()" class="btn-action-modern btn-primary-gradient">
        <i class="bi bi-download"></i>
        Exporter
      </button>
      {% if order.statut != 'LIVREE' and order.statut != 'ANNULEE' %}
        <button onclick="confirmCancelOrder()" class="btn-action-modern btn-danger-modern">
          <i class="bi bi-x-circle"></i>
          Annuler la Commande
        </button>
      {% endif %}
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
  <!-- Left Column: Products & Summary -->
  <div>
    <!-- Products Card -->
    <div class="card-ultra-detail animated">
      <div class="card-header-detail">
        <h3>
          <i class="bi bi-box-seam"></i>
          Articles Commandés
        </h3>
        <span class="badge-with-icon badge-info">
          <i class="bi bi-basket"></i>
          {{ items|length }} article{{ items|length|pluralize }}
        </span>
      </div>
      <div class="card-body-detail">
        {% for it in items %}
          <div class="product-item">
            {% if it.produit.image %}
              <img src="{{ it.produit.image.url }}" alt="{{ it.produit.nom }}" class="product-image">
            {% else %}
              <div class="product-image-placeholder">
                <i class="bi bi-box"></i>
              </div>
            {% endif %}
            
            <div class="product-details">
              <div>
                <div class="product-name">{{ it.produit.nom }}</div>
                <div class="product-meta">
                  <div class="product-meta-item">
                    <span class="product-meta-label">Quantité</span>
                    <span class="product-meta-value">{{ it.quantite }}</span>
                  </div>
                  <div class="product-meta-item">
                    <span class="product-meta-label">Prix Unitaire</span>
                    <span class="product-meta-value">
                      {% if it.unit_price %}
                        {{ it.unit_price|floatformat:0 }} FCFA
                      {% else %}
                        {{ it.produit.prix|floatformat:0 }} FCFA
                      {% endif %}
                    </span>
                  </div>
                </div>
              </div>
              
              <div class="product-total">
                <div class="product-meta-label">Sous-total</div>
                <div class="product-total-amount">
                  {% if it.line_total %}
                    {{ it.line_total|floatformat:0 }} FCFA
                  {% else %}
                    {% widthratio it.produit.prix 1 it.quantite %} FCFA
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% empty %}
          <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>Aucun article</h4>
            <p>Cette commande ne contient aucun article.</p>
          </div>
        {% endfor %}

        <!-- Order Summary -->
        <div class="order-summary">
          <div class="summary-row">
            <span class="summary-label">Sous-total</span>
            <span class="summary-value">{{ order.total|default:0|floatformat:0 }} FCFA</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Frais de livraison</span>
            <span class="summary-value">0 FCFA</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Réduction</span>
            <span class="summary-value">0 FCFA</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Total</span>
            <span class="summary-total">{{ order.total|default:0|floatformat:0 }} FCFA</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline Card -->
    <div class="card-ultra-detail animated mt-4">
      <div class="card-header-detail">
        <h3>
          <i class="bi bi-clock-history"></i>
          Historique de la Commande
        </h3>
      </div>
      <div class="card-body-detail">
        <div class="timeline">
          <div class="timeline-item active">
            <div class="timeline-content">
              <div class="timeline-title">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                Commande créée
              </div>
              <div class="timeline-date">{{ order.date_commande|date:"d/m/Y à H:i" }}</div>
            </div>
          </div>
          
          {% if order.statut == "EN_COURS" %}
          <div class="timeline-item active">
            <div class="timeline-content">
              <div class="timeline-title">
                <i class="bi bi-hourglass-split text-primary me-2"></i>
                En cours de traitement
              </div>
              <div class="timeline-date">En attente de livraison</div>
            </div>
          </div>
          {% endif %}
          
          {% if order.statut == "LIVREE" %}
          <div class="timeline-item active">
            <div class="timeline-content">
              <div class="timeline-title">
                <i class="bi bi-truck text-info me-2"></i>
                En cours de livraison
              </div>
              <div class="timeline-date">Livreur assigné</div>
            </div>
          </div>
          <div class="timeline-item active">
            <div class="timeline-content">
              <div class="timeline-title">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                Commande livrée
              </div>
              <div class="timeline-date">Livraison effectuée avec succès</div>
            </div>
          </div>
          {% endif %}
          
          {% if order.statut == "ANNULEE" %}
          <div class="timeline-item active">
            <div class="timeline-content">
              <div class="timeline-title">
                <i class="bi bi-x-circle-fill text-danger me-2"></i>
                Commande annulée
              </div>
              <div class="timeline-date">La commande a été annulée</div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column: Client Info & Map -->
  <div>
    <!-- Client Information -->
    <div class="info-card animated">
      <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: #1a1f26;">
        <i class="bi bi-person-circle me-2" style="color: #667eea;"></i>
        Informations Client
      </h3>
      
      <div class="client-info">
        <div class="client-avatar">
          {{ order.user.get_full_name|default:order.user.username|slice:":1"|upper }}
        </div>
        <div class="client-details">
          <h4>{{ order.user.get_full_name|default:order.user.username }}</h4>
          <p>
            <i class="bi bi-envelope me-1"></i>
            {{ order.user.email|default:"Non renseigné" }}
          </p>
        </div>
      </div>

      <div class="info-section" style="margin-top: 1.5rem;">
        <div class="info-label">
          <i class="bi bi-telephone"></i>
          Téléphone
        </div>
        <div class="info-value">
          {% if order.telephone %}
            <a href="tel:{{ order.telephone }}" style="color: #667eea; text-decoration: none;">
              <i class="bi bi-phone me-2"></i>{{ order.telephone }}
            </a>
          {% else %}
            Non renseigné
          {% endif %}
        </div>
      </div>

      <div class="info-section">
        <div class="info-label">
          <i class="bi bi-geo-alt"></i>
          Adresse de Livraison
        </div>
        <div class="info-value">
          {% if order.adresse_gps %}
            {{ order.adresse_gps }}
          {% elif order.adresse %}
            {{ order.adresse }}
          {% else %}
            Non renseignée
          {% endif %}
        </div>
      </div>

      {% if order.latitude and order.longitude %}
      <div class="gps-card">
        <div class="gps-coordinates">
          <div class="gps-icon">
            <i class="bi bi-crosshair"></i>
          </div>
          <div class="gps-values">
            <div class="gps-label">Coordonnées GPS</div>
            <div class="gps-value">{{ order.latitude }}, {{ order.longitude }}</div>
          </div>
        </div>
        <a href="https://www.google.com/maps?q={{ order.latitude }},{{ order.longitude }}" 
           target="_blank"
           class="btn-action-modern btn-primary-gradient w-100 justify-content-center">
          <i class="bi bi-map"></i>
          Ouvrir dans Google Maps
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Map Card -->
    {% if order.latitude and order.longitude %}
    <div class="card-ultra-detail animated">
      <div class="card-header-detail">
        <h3>
          <i class="bi bi-pin-map"></i>
          Localisation
        </h3>
        <span class="badge-with-icon badge-success">
          <i class="bi bi-geo-alt"></i>
          GPS Disponible
        </span>
      </div>
      <div class="card-body-detail">
        <div class="map-container">
          <div id="orderMap"></div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Payment Info Card -->
    <div class="info-card animated">
      <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 1.5rem; color: #1a1f26;">
        <i class="bi bi-credit-card me-2" style="color: #667eea;"></i>
        Informations de Paiement
      </h3>
      
      <div class="info-section">
        <div class="info-label">
          <i class="bi bi-cash"></i>
          Mode de Paiement
        </div>
        <div class="info-value">
          <span class="badge-with-icon badge-info">
            <i class="bi bi-cash-coin"></i>
            Paiement à la livraison
          </span>
        </div>
      </div>

      <div class="info-section">
        <div class="info-label">
          <i class="bi bi-clock"></i>
          Statut du Paiement
        </div>
        <div class="info-value">
          {% if order.statut == "LIVREE" %}
            <span class="badge-with-icon badge-success">
              <i class="bi bi-check-circle-fill"></i>
              Payé
            </span>
          {% else %}
            <span class="badge-with-icon badge-info">
              <i class="bi bi-hourglass-split"></i>
              En attente
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.15);">
      <div class="modal-header" style="border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1.5rem; background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(220,38,38,0.05));">
        <h5 class="modal-title" style="font-weight: 700; display: flex; align-items: center; gap: 0.75rem;">
          <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 1.5rem;"></i>
          Annuler la Commande
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 2rem;">
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.15)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-x-circle" style="font-size: 3rem; color: #ef4444;"></i>
          </div>
          <p style="font-size: 1.1rem; color: #1a1f26; margin-bottom: 0.5rem;">
            Êtes-vous sûr de vouloir annuler cette commande ?
          </p>
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05)); padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #667eea; margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: #64748b; font-weight: 600;">Commande</span>
            <span style="font-weight: 700; color: #667eea;">#{{ order.id }}</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: #64748b; font-weight: 600;">Client</span>
            <span style="font-weight: 700; color: #1a1f26;">{{ order.user.get_full_name|default:order.user.username }}</span>
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(220,38,38,0.05)); padding: 1rem; border-radius: 0.75rem; border: 2px solid rgba(239,68,68,0.2);">
          <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <i class="bi bi-info-circle-fill" style="color: #ef4444; font-size: 1.2rem; margin-top: 0.2rem;"></i>
            <div>
              <p style="margin: 0; font-size: 0.95rem; color: #64748b;">
                <strong>Attention :</strong> Cette action est irréversible. La commande sera définitivement annulée et ne pourra plus être traitée.
              </p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid rgba(0,0,0,0.05); padding: 1.5rem; gap: 0.75rem;">
        <button type="button" 
                class="btn" 
                data-bs-dismiss="modal"
                style="background: rgba(0,0,0,0.05); color: #64748b; border: none; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s ease;">
          <i class="bi bi-x-lg me-2"></i>
          Non, garder la commande
        </button>
        <form action="{% url 'admin_cancel_order' order.id %}" method="post" style="margin: 0;">
          {% csrf_token %}
          <button type="submit" 
                  class="btn" 
                  style="background: var(--danger-gradient); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(239,68,68,0.3); transition: all 0.3s ease;">
            <i class="bi bi-x-circle me-2"></i>
            Oui, annuler la commande
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if order.latitude and order.longitude %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const lat = {{ order.latitude|default:"null" }};
    const lng = {{ order.longitude|default:"null" }};
    
    if (lat && lng) {
      // Initialize map
      const map = L.map('orderMap').setView([lat, lng], 15);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      
      // Custom marker icon
      const customIcon = L.divIcon({
        className: 'custom-marker',
        html: '<div style="background: linear-gradient(135deg, #667eea, #764ba2); width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 4px 12px rgba(102,126,234,0.4); border: 3px solid white; display: flex; align-items: center; justify-content: center;"><i class="bi bi-geo-alt-fill" style="transform: rotate(45deg); color: white; font-size: 1.2rem;"></i></div>',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
      });
      
      // Add marker
      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
      
      // Add popup
      const popupContent = `
        <div style="padding: 0.5rem; font-family: 'Inter', sans-serif;">
          <h6 style="margin: 0 0 0.5rem 0; font-weight: 700; color: #1a1f26;">
            <i class="bi bi-pin-map-fill" style="color: #667eea;"></i>
            Adresse de Livraison
          </h6>
          <p style="margin: 0; font-size: 0.9rem; color: #64748b;">
            {% if order.adresse_gps %}{{ order.adresse_gps|escapejs }}{% else %}Client{% endif %}
          </p>
          <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #94a3b8; font-family: monospace;">
            ${lat.toFixed(6)}, ${lng.toFixed(6)}
          </p>
        </div>
      `;
      
      marker.bindPopup(popupContent).openPopup();
      
      // Add circle overlay
      L.circle([lat, lng], {
        color: '#667eea',
        fillColor: '#667eea',
        fillOpacity: 0.1,
        radius: 100
      }).addTo(map);
    }
  });

  // Export order function
  function exportOrder() {
    // Create notification
    showNotification('Export en cours...', 'info');
    
    // Simulate export (you can implement real export here)
    setTimeout(() => {
      showNotification('Commande exportée avec succès!', 'success');
    }, 1500);
  }

  // Confirm cancel order
  function confirmCancelOrder() {
    const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    modal.show();
  }

  // Notification system
  function showNotification(message, type = 'success') {
    const colors = {
      success: 'linear-gradient(135deg, #10b981, #059669)',
      error: 'linear-gradient(135deg, #ef4444, #dc2626)',
      info: 'linear-gradient(135deg, #3b82f6, #2563eb)',
      warning: 'linear-gradient(135deg, #f59e0b, #d97706)'
    };

    const icons = {
      success: 'check-circle-fill',
      error: 'x-circle-fill',
      info: 'info-circle-fill',
      warning: 'exclamation-triangle-fill'
    };
    
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: ${colors[type]};
      color: white;
      border-radius: 0.75rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 9999;
      animation: slideInRight 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      max-width: 400px;
    `;
    notification.innerHTML = `
      <i class="bi bi-${icons[type]}" style="font-size: 1.2rem;"></i>
      <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Add animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
</script>
{% endif %}
{% endblock %}